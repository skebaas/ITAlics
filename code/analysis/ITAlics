#!/bin/bash

# define a helper function to print usage information
function usage() {
    echo "Usage: $0 [-h] [-m MATLAB_PATH] [-s SESSION] config_file subject_path sequence_name"
    echo "Runs a Python program called task.py with the specified inputs"
    echo "The 'task.py' script will run the entirety of the 1st levels"
    echo ""
    echo "Positional arguments:"
    echo "  config_file         Path to the Python configuration file"
    echo "  subject_path        Path to the subject directory"
    echo "  sequence_name       Name of the sequence to process"
    echo ""
    echo "Optional arguments:"
    echo "  -h, --help          Show this help message and exit"
    echo "  -m, --matlab-path   Path to the MATLAB executable (default: matlab)"
    echo "  -s, --session       Session number (default: 1)"
}

# set default values
matlab_path=""
session=1

# parse command line arguments
if [ -d /usr/local/software/MATLAB/R2015a ];then
	matlab_path=/usr/local/software/MATLAB/R2015a/bin
elif [ -d /usr/local/MATLAB/R2015a ];then
	matlab_path=/usr/local/MATLAB/R2015a/bin
else
	echo "could not find MATLAB folder"
fi
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -m|--matlab-path)
            matlab_path="$2"
            shift 2
            ;;
        -s|--session)
            session="$2"
            shift 2
            ;;
        -*)
            echo "Error: unrecognized option $1"
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

# check for nipype, pandas, and configparser Python modules
if ! python3 -c "import nipype" >/dev/null 2>&1 || \
   ! python3 -c "import pandas" >/dev/null 2>&1 || \
   ! python3 -c "import chardet" >/dev/null 2>&1 || \
   ! python3 -c "import networkx; exit(networkx.__version__ != '2.5')" 2>&1 || \
   ! python3 -c "import configparser" >/dev/null 2>&1; then
    echo "WARNING: Python modules nipype, pandas, and configparser are required"
    echo "Installing now!"
    python3 -u -m pip install nipype pandas configparser chardet networkx==2.5
fi

# add MATLAB to the PATH if it's not already there
if [[ ! $(command -v matlab >/dev/null 2>&1) || ! $(ls -la $(which matlab) | awk -F ' ' '{print $NF}') == *"R2015"* ]] ;then
    	export PATH=${matlab_path}:${PATH}
fi

# add afni to the PATH if it's not already there
if ! command -v 3dDespike >/dev/null 2>&1; then
    export PATH=$PATH:/usr/local/software/afni/bin
fi
# Configure MATLABPATH
export MATLABPATH=/usr/local/software/ITAlics/matlab/embarc-2.0:/data/github/ITAlics/code/analysis/matlab/PPPI/:/data/github/ITAlics/data/spm12

# get the input arguments
config_file=$1
subject_path=$2
sequence_name=$3
echo $0

# Add in path of bin
# This is so the 'eprime2csv' script can be accessed by matlab for creating the design matrix
export PATH=$PATH:/data/github/ITAlics/code/analysis/bin/
# run the Python program
python3 /data/github/ITAlics/code/analysis/bin/task.py $config_file $sequence_name $subject_path $session
